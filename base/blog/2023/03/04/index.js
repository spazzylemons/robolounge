var MazeTile,Direction,__extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();!function(e){e[e.Empty=0]="Empty",e[e.Wall=1]="Wall",e[e.Dot=2]="Dot",e[e.Treasure=3]="Treasure",e[e.SpawnWall=4]="SpawnWall"}(MazeTile||(MazeTile={})),function(e){e[e.Right=0]="Right",e[e.Down=1]="Down",e[e.Left=2]="Left",e[e.Up=3]="Up"}(Direction||(Direction={})),function(){var e,t,r,n,a=40,o=40,i=21,l=Math.floor(i/2+1),f=27,u=Math.floor(f/2)-1,h=u+2,s=l-3,c=l-1,p=h+5,v=((e={})[Direction.Right]=[1,0],e[Direction.Down]=[0,1],e[Direction.Left]=[-1,-0],e[Direction.Up]=[0,-1],e),M=function(){function e(e,t){this.x=e,this.y=t}return e.prototype.canPassThrough=function(e){switch(e){case MazeTile.Empty:case MazeTile.Dot:case MazeTile.Treasure:return!0;default:return!1}},e.prototype.move=function(e,t){var r=this.x+e,n=this.y+t;-1===r?r=i-1:r===i&&(r=0),this.canPassThrough(j[n][r])&&(this.x=r,this.y=n)},e}(),y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.move=function(t,r){e.prototype.move.call(this,t,r);var n=j[this.y][this.x];n!==MazeTile.Dot&&n!==MazeTile.Treasure||(j[this.y][this.x]=MazeTile.Empty)},t}(M),T=function(e){function t(t,r,n){var a=e.call(this,t,r)||this;return a.targetAlgorithm=n,a.direction=Direction.Up,a.tunnelPenalty=!1,a}return __extends(t,e),t.prototype.chase=function(){for(var e=this.targetAlgorithm(),t=e[0],r=e[1],n=1/0,a=this.direction,o=0;o<4;o++)if((o+2&3)!==this.direction){var l=v[o],u=l[0],h=l[1],s=this.x+u,c=this.y+h;if(!(s>=0&&s<i&&c>=0&&c<f)||this.canPassThrough(j[c][s])){var p=s-t,M=c-r,y=p*p+M*M;y<n&&(n=y,a=o)}}this.direction=a;var T=v[this.direction],m=T[0],z=T[1];this.move(m,z)},t.prototype.move=function(t,r){this.tunnelPenalty?this.tunnelPenalty=!1:(e.prototype.move.call(this,t,r),this.y===n&&(this.x<3||this.x>i-4)&&(this.tunnelPenalty=!0))},t}(M);function m(e,t){return e-t}function z(e,t,r){return r.indexOf(e)===t}function g(e,t,r){var n=[],a={},o=0;function u(e,t){return e+","+t}function h(e,t){return u(e,t)in a}function s(t,r){if(!(t<0||t>=i||r<0||r>=f)){var o=t>=l?i-1-t:t;e[r][o]===MazeTile.Wall&&(h(t,r)||(n.push([t,r]),a[u(t,r)]=!0))}}for(s(t,r);o<n.length;){var c=n[o++],p=c[0],v=c[1];s(p-1,v),s(p+1,v),s(p,v-1),s(p,v+1)}for(var M=[],y=0;y<n.length;y++){var T=n[y],g=T[0],d=T[1],x=h(g-1,d),w=h(g+1,d),D=h(g,d-1),W=h(g,d+1);(x&&w&&!D&&!W||D&&W&&!x&&!w)&&M.push(y)}for(y=M.length-1;y>=0;y--){var E=M[y],_=n[E],b=_[0],P=_[1];n.splice(E,1),delete a[u(b,P)]}if(n.length>5)return!1;var A=n.map((function(e){var t=e[0];e[1];return t})).filter(z).sort(m),k=n.map((function(e){e[0];return e[1]})).filter(z).sort(m),S=A[A.length-1]-A[0],O=k[k.length-1]-k[0];if(S>4||O>4)return!1;if(n.length<4)return!0;if(5===n.length){if(3===A.length&&3===k.length){for(var L=k[1],U=0,C=A;U<C.length;U++){if(!h(C[U],L))return!1}for(var R=A[1],j=0,q=k;j<q.length;j++){if(!h(R,q[j]))return!1}return!0}return!1}if(3===A.length){for(var B=0,F=A[1],I=0,$=n;I<$.length;I++){var G=$[I],H=G[0];G[1];F===H&&++B}return 2===B}if(3===k.length){B=0;for(var J=k[1],K=0,N=n;K<N.length;K++){var Q=N[K];Q[0];J===Q[1]&&++B}return 2===B}return!1}for(var d=((t={})[MazeTile.Empty]=" ",t[MazeTile.Wall]="#",t[MazeTile.Dot]="-",t[MazeTile.Treasure]="$",t[MazeTile.SpawnWall]="=",t),x=((r={})[MazeTile.Empty]="000",r[MazeTile.Wall]="742",r[MazeTile.Dot]="782",r[MazeTile.Treasure]="782",r[MazeTile.SpawnWall]="aaa",r),w=document.getElementById("screen"),D=[],W=[],E=0;E<o;E++){for(var _=[],b=[],P=0;P<a;P++){_.push([" ","000"]);var A=document.createElement("span");b.push(A),w.appendChild(A)}W.push(_),D.push(b),w.appendChild(document.createElement("br"))}var k=!1;function S(e,t,r,n){e<0||e>=a||t<0||t>=o||(W[t][e]=[r,n],k||(k=!0,requestAnimationFrame((function(){for(var e=0;e<a;e++)for(var t=0;t<o;t++){var r=W[e][t],n=r[0],i=r[1];D[e][t].textContent=n,D[e][t].style.color="#"+i}k=!1}))))}var O,L=new y(c,p),U=[L.x,L.y];O=[new T(l-3,u-1,(function(){return[L.x,L.y]})),new T(l-2,u-1,(function(){var e=L.x-U[0],t=L.y-U[1];return L.x===U[0]&&L.y===U[1]||(U[0]=L.x,U[1]=L.y),[L.x+4*e,L.y+4*t]})),new T(l,u-1,(function(){return[Math.floor((O[0].x+O[3].x)/2),Math.floor((O[0].y+O[3].y)/2)]})),new T(l+1,u-1,(function(){return[O[0].x+Math.floor(9*Math.random())-4,O[0].y+Math.floor(9*Math.random())-4]}))];var C=["f00","0f0","08f","72f"];function R(e){for(var t=0;t<f;t++)for(var r=0;r<i;r++){var n=e[t][r];S(r,t,d[n],x[n])}S(L.x,L.y,"@","ff0");for(var a=0;a<4;a++)S(O[a].x,O[a].y,"M",C[a])}var j=function(){for(var e=[],t=0;t<f;t++){for(var r=[],a=0;a<l;a++)r.push(MazeTile.Empty);e.push(r)}for(t=0;t<f;t++)e[t][0]=MazeTile.Wall;for(a=0;a<l;a++)e[0][a]=MazeTile.Wall,e[f-1][a]=MazeTile.Wall;var o=[];for(t=2;t<f-2;t+=2)for(a=2;a<l;a+=2)e[t][a]=MazeTile.Wall,o.push([a,t]);for(t=u;t<h;t++)e[t][s]=MazeTile.Wall;for(a=s;a<l;a++)e[u][a]=MazeTile.Wall,e[h][a]=MazeTile.Wall;for(e[u][l-1]=MazeTile.SpawnWall,n=5+2*Math.floor(Math.random()*Math.floor((f-9)/2)),a=0;a<2;a++)e[n-1][a]=MazeTile.Wall,e[n+1][a]=MazeTile.Wall;function v(e,t){return e>=s-1&&t>=u-1&&t<=h+1||(e<4&&Math.abs(t-n)<3||t==p&&Math.abs(e-c)<2)}e[n][0]=MazeTile.Empty;var M=[],y=[];for(t=2;t<f-2;t++)for(a=2;a<l;a++)(1&t)==(1&a)||v(a,t)||M.push([a,t]);function T(t,r){return t>=l&&(t=i-1-t),e[r][t]===MazeTile.Empty}function m(){if(0!==M.length){var e=Math.floor(Math.random()*M.length),t=M.splice(e,1)[0];return[t[0],t[1]]}var r=Math.floor(Math.random()*y.length),n=y.splice(r,1)[0];return[n[0],n[1]]}function z(e,t){return 0!=(1&e)||0!=(1&t)||(!!T(e,t)||T(e-1,t)&&T(e+1,t)&&T(e,t-1)&&T(e,t+1))}function d(){for(var e=0;e<M.length;e++){var t=M[e],r=t[0],n=t[1];z(r-1,n)||z(r+1,n)||z(r,n-1)||z(r,n+1)||o.splice(e--,1)}}for(;0!==M.length||0!==y.length;){var x=m();a=x[0],t=x[1];e[t][a]=MazeTile.Wall,g(e,a,t)?d():e[t][a]=MazeTile.Empty}for(t=0;t<f;t++)for(a=0;a<i;a++)e[t][a]===MazeTile.Empty&&(t===n&&a<3||t==p&&Math.abs(a-c)<2||(t<u-2||t>h+2||a<s-2)&&(e[t][a]=MazeTile.Dot));for(e[1][1]=MazeTile.Treasure,e[f-2][1]=MazeTile.Treasure,t=0;t<f;t++)for(a=l-2;a>=0;a--)e[t].push(e[t][a]);return e}();R(j),document.body.addEventListener("keydown",(function(e){switch(e.key){case"ArrowLeft":L.move(-1,0),R(j);break;case"ArrowRight":L.move(1,0),R(j);break;case"ArrowUp":L.move(0,-1),R(j);break;case"ArrowDown":L.move(0,1),R(j);break;case"Space":break;default:return}e.preventDefault();for(var t=0,r=O;t<r.length;t++){r[t].chase()}}))}();
